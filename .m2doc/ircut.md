# 基于曝光值和场景学习算法实现控制IRCUT和红外灯的方法

专利 = 想法 + 包装

* 知道自己的目标
* 知道自己的弱点

# 技术领域

本发明属于安防监控领域中的红外补光摄像机的应用技术领域，涉及一种基于曝光值和场景学习算法控制IRCUT和红外灯的方法。

# 背景技术

根据计算机系统输入、处理、输出的系统划分方法，安防监控摄像机的夜视切换控制系统划分如下：
1 输入：光敏电阻
2 处理：软件控制算法
3 输出：红外灯、IRCUT

第1代IRCUT控制，通过读取光敏，感应外界环境的照度(单位Lux)，低照度(小于3Lux)时开红外灯，IRCUT开启全透光滤光片，高照度(大于5Lux)时，关红外灯，IRCUT开启滤红光滤光片。

第2代IRCUT控制，去掉了光敏，通过读取SENSOR成像后图片的EV值(Exposure Values 曝光值)，然后将EV值转化为对应的照度，进行对IRCUT和红外灯进行控制。

第1代IRCUT算法，因为使用了光敏元器件，有如下不足：
1 增加了硬件成本及增加装配步骤。
2 在光敏感光面与成像画片有较大出入，如背光环境下，光敏不能准确地表征图像照度。
3 在星光级摄像机中，低照度下，光敏会出现精度不足的现象。
4 在北方早晚温差较大环境中，光敏会有温漂现象，会出现早晚同样照度的表征值差距较大的现象。

第2代IRCUT算法，在低照度场景下，红外开启后，EV值与照度并不成正比例关系，具体表现为：
1 距离越近，反光越集中，EV值越大。例如镜头贴近桌面，EV值会很大，会被误判为白天。
2 画面中物体反光率越高(白色最高，黑色最低)，EV值越大。
3 画面中有运动物体，造成EV值抖动，造成IRCUT误切。
4 算法的场景适应能力，当前的消费类摄像机会有移动场景的需求。

# 发明内容

本发明为了弥补现有技术的不足，提供了一种基于曝光值和场景学习算法控制IRCUT和红外灯的方法。

本发明基于EV值，EV值、图像亮度和环境照度的关系为：在给定感光度下，曝光值与亮度（或照度）以及图像亮度是**正相关**关系。

本发明，在第2代算法的基础上，在第2代IRCUT算法上进行了大胆改进，基于白天模式时，EV值必定反应环境照度这个有利条件，对不同的静态环境进行学习，并且进行试错，动态调整内部参数，对于光线快速变化和移动场景，通过EV值的差值进行快速判断，以此两点拟合出一个完美的以照度、反光率、距离为自变量的函数，以期对IRCUT和红外灯达到准确的控制。

使用第3代IRCUT算法后，摄像机的适应场景更加灵活可靠，不仅节约了成本，而且改进结构后，设备更加美观大方。

本发明基于白天模式时，EV值必定反应环境照度这个有利条件，对不同的静态环境进行学习，并且进行试错，动态调整内部参数，对于光线快速变化和移动场景，通过EV值的差值进行快速判断，以此两点拟合出一个完美的以照度、反光率、距离为自变量的函数，以期对IRCUT和红外灯达到准确的控制。

# 具体实施方式

## 一、算法基于一组经验值对场景进行互斥不重复分类

*速变模式*
  速变即快速**开关灯**。
  时刻学习环境中{开灯+LED}时的联合EV值。

*渐变模式*
  ev_3lux     白天模式下，3 LUX 对应的 EV 值。
  ev_6lux     夜视模式下，6 LUX 对应的 EV 值。
  ev_normal   夜视模式下，白炽灯亮，摄像机对准普通生活场景(画片中物体反光率适中)，摄像机与画面3米距离对应的EV值。
  ev_ceiling  夜视模式下，白炽灯亮，摄像机对准天花板(画片中物体反光率较高)，摄像机与画面3米距离对应的EV值。
  ev_extrem   夜视模式下，白炽灯亮，摄像机面片中一半是桌面(画片中物体反光率较高)，摄像机与画面1.5米距离对应的EV值。

## 二、算法启动后对环境进行学习的几组数据说明

  ev_white    白天模式下，最近的20次EV采样值集合，总计50秒，适用于场景切换特别快的场景
  ev_black    夜视模式下，最近的6次EV采样值集合，总计15秒
  ev_sta      夜视模式下，从第11秒开始，3次EV采样值集合的平均值
  ev_env      夜视模式下，最小的3次EV采样值集合的平均值

              ev_env >= ev_extrem，高亮环境
              ev_env < ev_extrem && ev_env >= ev_ceiling，中亮环境
              ev_env < ev_ceiling && ev_env >= ev_normal，低亮环境
              ev_env < ev_normal && ev_env >= ev_6lux，超低亮环境
              ev_env < ev_6lux，正常全黑环境

  ev_time     夜视模式切白天模式的时间集合
  ev          最新的EV采样值
  x_black     EV环境敏感系数，越大越不灵敏，超低亮、低亮、中亮、高亮分别初始化为1，0.99，0.97，0.95，每次上调15%

## 三、算法步骤

  步骤1   初始化状态为白天模式，此模式下，红外灯关，IRCUT开启滤红光滤光片。此模式下EV值能准确反应环境照度。如果 `ev < ev_3lux`达到3次，进入步骤2
  步骤2   基于画片切换时画片EV不稳定，忽略前10秒数据。从第11秒开始收集各项数据。分别进行步骤3到步骤6的筛选。
  步骤3   如果在第11秒到第35秒间，ev_white中的最大值大于3倍ev_3lux，且`ev>3*ev_6lux`，且`ev<ev_ceiling`，记录ev_time，进入步骤7
  步骤4   正常全黑环境下，`ev > ev_6lux`达到3次，记录ev_time，进入步骤7。
  步骤5   低亮、中亮、高亮环境下，`ev<ev_env*90%/x_black`达到3次，表明此时，有人在调整镜头，使画面开始拉远或摆正，有人的情况下大多光线明亮，记录ev_time，进入步骤7
  步骤6   低亮、中亮、高亮环境下，`ev>ev_env*110%*x_black`达到3次，表明光线逐渐转亮，记录ev_time，进入步骤7
  步骤7   检查ev_time中2次夜视模式转白天模式的时间间隔，或小于120秒，则表明判断错误，调整系数x_black，若调整系数时间达到5小时，重置系数x_black。进入步骤1

# 流程图

# 常用场景测试

| No. | 初始条件                     | 输入操作           | 预期结果                                  |
| :-- | :------                      | :------            | :------                                   |
| 1   | 黑夜 LED亮                   | 光线渐亮，等待黎明 | LED灭                                     |
| 2   | 白天 LED灭                   | 光线渐暗，等待黄昏 | LED亮                                     |
| 3   | 黑夜 LED亮                   | 开灯               | LED灭                                     |
| 4   | 黑夜 日光灯亮 LED灭          | 关灯               | LED亮                                     |
| 5   | 黑夜                         | 白天->黑夜->白天   | LED 白亮黑灭                              |
| 6   | 白天                         | 黑夜->白天->黑夜   | LED 白亮黑灭                              |
| 7   | 挑战3次临界采样时间          | 手捂手松           | 手捂手松与快速开关灯是同样的逻辑          |
| 8   | 白光LED灭+近距离高反射率场景 | 关灯               | LED亮                                     |
| 9   | 黑夜LED亮+近距离高反射率场景 | 开灯               | 不确定，LED可亮，做为环境摆放不正确的提示 |
| 10  | 有其它厂家红外设备干扰       | 错开切换时间       | 在多次切红外时，保持默认状态              |

附加说明：
1 假设1：设置多数场景是固定的，不摇晃设备
2 假设2：不挑战极限条件：{场景反射率|距离，光源强度，切换时间}
  近距离高反射率场景，**存在不确定性**
  设备无法区分红外LED与日光灯，因此在有*强红外干扰*的情况下，**存在不确定性**
  白光采样时间 3x 1s，夜光采样时间 3x 2.5s，低于此采样时间，**存在不确定性**
3 考虑过[收敛](~/fc/encode_infrared.c.congv)，但收敛会导致有人场景反应迟钝，取消之

# 继续改进

1 增加 acc_f
2 多次切换后重置 ev_env
