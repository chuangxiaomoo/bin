#! /bin/bash

. `dirname ${0}`/'dbank' || { echo "dbank err" && exit; }
. /etc/common.rc

function fn_routine_1_0()
{
    tips_cnt=0
    tips_got=''

    while read code symble FM cond1 op cond2 tips; do
        if ! ${istest} && [ "$code" != '-' ]; then                              # istest
            echo do fenbi ${code}...
            fenbi ${code} >& ${error}
            xt_ret $? "down ${code}" || { cat ${error}; return $?; }
        fi
        if [ "${code}" = '-' ] && [ -n "$code0" ]; then # code is -
            code=$code0
        else
            FM=${FM} macd ${code}                       # 自FM固定为5后，可只作一次macd
            xt_ret $? "macd error" || return $?
        fi

        sql="SELECT IF(${cond1} ${op} ${cond2}, 1, 0) FROM mm55 WHERE code=${code} and FM=${FM}"
        ret=`mysql -N kts <<<"${sql}"`

        # echo "${sql}"

        if [ "${ret}" = 1 ]; then
            fn_echo_succ "$code.$symble.$FM $cond1 $op $cond2"
            fn_echo_warn "$tips"
            let tips_cnt++
        elif [ "${ret}" = "" ]; then
            fn_echo_fail "bad condition ${code}: ${cond1} ${op} ${cond2}"
            fn_bell "bad condition"
        fi
        code0=$code
    done<<<"`grep ${PATTERN:-'^[-036]'} .soptter.macd`"
    
    local i
    for (( i=${tips_cnt}; i>0; i-=3 )); do
        tips_got="${tips_got} duang.wav msg.wav"    # 2个股+2指数 = 一级戒备
    done
    #echo ${tips_got}
    [ -n "${tips_got}" ] && fn_bell "$tips_got"

    fn_echo_warn '
    Warning:-----------------------------------------------------------------
    1. 跌不必贱，涨不必贵，水无贵贱。水能载舟，亦能覆舟，上善若水。
    2. 请遵守F5x3有效确认(K线实体站上ma55，即便晚15分，你的成本也很低)
    3. 根据大盘决定整体仓位
    4. (a)保住本金; (b)请永远记住第一条; (c)直至2015-07-30最后5分钟亦可出半仓
    5. 如遇涨停，挂1/2委托单做T+0(不因利小而不为)
    '
}

function fn_routine()
{
    tips_cnt=0
    tips_got=''
    >${list_limo}

    while read code symble IF tips; do
        if ! ${istest} && [ "$code" != '-' ]; then                              # istest
            echo do fenbi ${code}...
            fenbi ${code} >& ${error}
            xt_ret $? "down ${code}" || { cat ${error}; return $?; }
        fi

        if [ "${code}" = '-' ]; then # code is -
            code=$code0
        else
            FM=15 macd ${code}
            xt_ret $? "macd error" || return $?

            sql='(FM=15)*IF(close>=fa15, 1, -1)*((fa15>=ma5)+(fa15>=ma10)+(fa15>=ma20)+(fa15>=ma40)+(fa15>=ma80))'
            sql="SELECT ${sql} FROM mm55 WHERE code=${code} and FM=15"
            limo=`mysql -N kts <<<"${sql}"`

            # 5日线上，B用4数，S用3数；5日线下，B用3数，S用3数
            sql="SELECT IF(close>ma80,4,3) FROM mm55 WHERE code=${code} and FM=15"
            buyn=`mysql -N kts <<<"${sql}"`

            # macd计算作为BuySell的标配进行，但对其进行下列优化，触发执行
            # 1. 上一个时间单元abs(dif)<0.006
            # 2. 上一个更新时间>10min
            # 3. ${istest}
            sql="SELECT abs(dif)<0.006 || (CURRENT_TIMESTAMP()-datetime)>1000 FROM mm55 WHERE code=${code} and FM=5"
            ret=`mysql -N kts <<<"${sql}"`

            if ${istest} || [ "${ret}" = 1 ] || [ "${ret}" = "" ]; then
                echo "do _dif_ ${code}..."
                FM=5 macd ${code}
                xt_ret $? "macd error" || return $?
            fi
        fi

        case ${IF:-B} in
        B)
            if [ "${limo}" -gt 0 ] && [ "${limo}" -ge ${buyn:-3} ]; then
                fn_echo_succ "$code.$symble.limo ${IF}"
                let tips_cnt++
            fi
            sql="SELECT IF(dif>0&&close>fa15, 1, 0) FROM mm55 WHERE code=${code} and FM=5"
            ret=`mysql -N kts <<<"${sql}"`
            if [ "${ret}" = 1 ]; then
                fn_echo_succ "$code.$symble.macd ${IF}"
                let tips_cnt++
            fi
            ;;
        S)
            if [ "${limo}" -lt 0 ] && [ "${limo#-}" -lt 3 ]; then
                fn_echo_succ "$code.$symble.limo ${IF}"
                let tips_cnt++
            fi
            sql="SELECT IF(dif<0&&close<fa15, 1, 0) FROM mm55 WHERE code=${code} and FM=5"
            ret=`mysql -N kts <<<"${sql}"`
            if [ "${ret}" = 1 ]; then
                fn_echo_succ "$code.$symble.macd ${IF}"
                let tips_cnt++
            fi
            ;;
        *)
            sql="SELECT IF(${IF}, 1, 0) FROM mm55 WHERE code=${code} and FM=15"
            ret=`mysql -N kts <<<"${sql}"`
            if [ "${ret}" = 1 ]; then
                fn_echo_succ "$code.$symble.cond ${IF}"
                fn_echo_warn "$tips"
                let tips_cnt++
            elif [ "${ret}" = "" ]; then
                fn_echo_fail "bad cond: ${IF}"
                fn_bell "msg.wav msg.wav msg.wav"
            fi
            ;;
        esac

        x_mavol=`cat ${file_mavol}`
        sql="SELECT IF(mavol5/mavol20>${x_mavol:-2}, 1, 0) FROM mm55 WHERE code=${code} and FM=15"
        ret=`mysql -N kts <<<"${sql}"`
        if [ "${ret}" = 1 ]; then
            fn_echo_succ "$code.$symble.cond mavol5/mavol20>${x_mavol}"
            let tips_cnt++
        fi

        [ "${tips_cnt}" -gt ${tips_old:-0} ] && echo ${code} >> ${list_limo}
        code0=$code
        tips_old=${tips_cnt}
    done<<<"`grep ${PATTERN:-'^[-036]'} .soptter.macd`"
    
    local i
    for (( i=${tips_cnt}; i>0; i-=6 )); do
        tips_got="${tips_got} duang.wav msg.wav"    # 2个股+2指数 = 一级戒备
    done
    #echo ${tips_got}
    if [ -n "${tips_got}" ]; then
         fn_bell "$tips_got"
         YIST=${list_limo} SELECT macd
    fi

    fn_echo_warn '
    Warning:-----------------------------------------------------------------
    1. 跌不必贱，涨不必贵，水无贵贱。水能载舟，亦能覆舟，上善若水。
    2. 根据大盘决定整体仓位
    3. 当天出现过卖出信号的，当天不可以买入。可：dif第一次跌破时，小仓博反弹
    '
}

function fn_loop()
{
    while :; do
        fn_isresting && { sleep 150; continue; }
        fn_routine
        echo "to sleeping ${intv:=120}s"        # F5x3有效突破，即3线之内，低点抬高，高点亦抬高
        sleep ${intv}                           #               若是大阳线，则不破1/2长度
    done
    return $?
}

function fn_usage()
{
    echo "Usage: nb_macd code"
    echo "       nb_macd l|loop"
    echo "       nb_macd t|test_all"
    exit
}

function fn_test_all()
{
    fn_routine
    xt_ret $? "" || return $?
}

function fn_test_code()
{
    fn_iscode ${1}
    xt_ret $? "bad code ${1}" || return $?

    PATTERN="^${1}" fn_routine
    xt_ret $? "" || return $?

    return $?
}

function fn_main()
{
    istest=false
    echo '2' >${file_mavol}
    case $1 in
    l|loop)
        fn_loop
        ;;
    t|test_all)
        istest=true
        fn_test_all
        ;;
    [0-9][0-9]*)
        fn_test_code ${@}
        ;;
    *)
        fn_usage
        ;;
    esac

    return $?
}

fn_main ${@}
