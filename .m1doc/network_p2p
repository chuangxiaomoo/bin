# P2P

https://www.zhihu.com/question/285394457


# P2P连接建立过程

P2P连接的建立首先需要一个拥有公网IP的中间服务器S，两个结点P1和P2。

1、结点P1和P2分别发送数据包给S，数据包在经过NAT时，ip和port进行转换，ip转换为公网ip，port是否转换需要看NAT的具体实现。S拿到转换后的P1和P2的地址。
2、S将P1的地址发给P2，将P2的地址发给P1。这里的地址都是NAT地址。
3、P1收到P2地址后，尝试建立连接，首先发送消息包给P2（其实是P2的NAT），P2也同样这样做，在两个结点都收到对方的消息包之后，就可以进行通信了。这个过程也叫做打洞。

之所以需要有打洞这个过程，是因为，NAT会丢弃自己不认识的地址包，让NAT认识它的方法，就是发出一个到这个地址的数据包。比如让A认识B，那就让A发一个数据包给B，不然，B发给A的数据包就会被丢弃。所以打洞的过程不是为了收到对方的数据包，而是为了发送数据包给对方，从而认识对方。这样，之后的通信就可以正常进行了。

刚才之所以说只有锥型NAT才可以进行P2P，原因在第三步可以看出来。结点进行打洞的地址，是通过服务器拿到的，而这个地址在对称型NAT的情况下，并不是一定的，可能会随时发生变化。也就是说，P1与服务器通信使用的NAT地址和P2与P1通信使用的NAT地址是不同的（一般情况都是端口不同）。甚至P1与服务器通信使用的NAT地址都在不断的发生变化。这样让我们没办法拿到隐藏在NAT后边内网设备的NAT入口，也就没办法进行P2P通信了。

P2P也用到了一个服务器，跟微信一样。但是不同的是，P2P中的服务器只作为结点地址的中转站，而微信的服务器是数据的聚宝盆。P2P让我们的数据仅通过P2P连接发送，而不经过任何第三方的服务器。

————————————————
版权声明：本文为CSDN博主「naget」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/qq_33240946/article/details/104717234

