#! /bin/bash

. Model

    按照输入、处理、输出的模式来定义系统。(可参考人体的输入-器官处理-输出)
    按照定义类的方式，抽象系统的属性（包括数据及操作）
    找出“五脏六腑”之类的“输入到输出”的运行法则，转化其为处理代码

  ┌───────────┐      ┌──────────┐      ┌─────────────┐
  │ 口（food）│ ---> │ 五脏六腑 │ ---> │ 魄门（shit）│
  └───────────┘      └──────────┘      └─────────────┘

. 输入（报警源）：
    Spark Detect，拉弧检测
    策略，是否启用，          侦测灵敏度，侦测区域

    Motion Detect，移动侦测
    策略，是否启用，布防时间，侦测灵敏度，侦测区域

    Video Loss，视频丢失
    策略，是否启用，布防时间，侦测灵敏度

    GPIO，报警输入，四路 （枪从alarm.ko，球从485，单兵从：左上角按键和控制线上的大红按钮同源）
    策略，是否启用，布防时间

    Extend Alarm，扩展报警
    球机通过485协议与扩展设备通信，接收报警输入


. 输出：    
    网络报警中心
    E-mail
    FTP上传

    播放声音
    前端录像
    抓拍

    GPIO报警输出    # 必须有硬件电路支持
    跳转到预置位

    WEB指示灯闪动   # 做为提示，但不在联动范围内

. 联动处理：
    一个输入可以对应多个输出。在"报警设置->报警联动"中查看对应关系。

    ca2vlcfg 联动设置:视频丢失

    ca2mdcfg 联动设置:移动侦测
    ┌─────────────────────────────────────────────────────────┐
    │   报警中心                                              │
    │   报警输出1                                             │
    │   报警输出2                                             │
    │   播放声音                                              │
    │                                                         │
    │   前端录像    # record 与 capture 依赖存储              │
    │   抓拍图片                                              │
    │                                                         │
    │   邮件图片    # email 与 ftp 不依赖与存储               │
    │   FTP上传图片 FTP上传录像 # 只2选1                      │
    └─────────────────────────────────────────────────────────┘

    
报警上报频率层次：
    ┌────────────────────────────────────────────────────────┐
    │raw(encode) # 驱动采样 frequence                        │
    │alarm       # 限定为5s intervel                         │
    │user        # 对应"报警联动->报警时间间隔" (5~36000秒)  │
    └────────────────────────────────────────────────────────┘

相关JCP：
    getalarmmsg -act list                           
        WEB指示灯闪动，网页每3秒向server请求一次报警，并将报警记录保存在cookie中。
        server发送相应记录给网页，并删除相应记录。

        所以，如果要使用命令获取报警记录，需要先关掉网页，触发报警，再getalarmmsg

    alarmtest -act set -chn 1/cif -alarmtype 1 -filter 1
        alarmtest的本质是模拟jco_encode等"报警源"，给jco_alarm发送一条消息。

        jco_alarm的处理流程:
           ┌───────────┐
           │1. 是否启用│
           └─────┬─────┘
           ┌─────┴─────┐
           │2. 布防时间│
           └─────┬─────┘
           ┌─────┴──────────────────────────┐
           │3. MD侦测区域    探头报警       │
           │   侦测灵敏度                   │
           └─────┬──────────────────────────┘
           ┌─────┴─────────┐
           │4. 处理联动报警│
           └───────────────┘

        模拟报警，filter为1时，启用强制布防，即越过1 2 3步的检查，直接进入
        "处理联动报警"。

        也就是说，有了此功能，可以单独测试联动操作，方便测试。

附录：
    circuit_alarm                                       # 报警电路 
    E:\winc\qdoc\报警说明书_V1.1.doc    


入档日期: 2013-02-27

