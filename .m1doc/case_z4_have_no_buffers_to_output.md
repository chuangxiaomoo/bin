# have no buffers to output

*0. 最初反馈*

Mar.30

恢复出厂默认导致系统重启，系统无法响应输入。
实际情况是: 任何重启(HW Reset, SW Reset)都可能导致不出帧。

*1. 昨天的重启问题，我的猜测是CPU过高导致喂狗失败重启。*

> HW Reset
> SW Reset
> WDT Reset

@老肥狗 @Abner 昨天的重启问题，我的猜测是CPU过高导致喂狗失败重启。如果 IPL 中打印不出相应信息，我想先跳过这个打印。我的思路是这样，在内核中禁用watchdog，在出现cpu过高时，有足够的时间就可以执行命令，采集你们要的信息。我在内核 drivers/mstar/watchdog/mdrv_wdt.c 中 infinity_wdt_start 直接返回，没有能够禁用watchdog，应该怎么处理？

WatchDog 
htop -> ISP_workqueue

系统是否有调度
> SCHED_OTHER 分时调度策略，（默认的）
> SCHED_FIFO  实时调度策略，先到先服务，一旦占用cpu则一直运行，直到有更高优先级任务到达或自己放弃。
> SCHED_RR    实时调度策略，时间片轮转，不是真正的改变进程的优先级，而是改变进程的基本时间片的长度。

*2. 麻烦同时确认下sensor这边的供电和mclk稳不稳，现在sensor的嫌疑比较重*

你们有SD卡吗

clk是27兆，几个供电电压都是正常的

> setprop iq.debug.iq_enable 0

升级之后是紫屏，这是正常的吗？

sensor frame 最开始是25，黑光的只需要15，但我们内部使用 MI_VI_SetSensorFrameRate() 地方我都标记了，启动第一次打印还是25

高的还是ISP_WORKQUEUE线程吗

*3. reset波形？*

更新最新的驱动，刚才有一个小卡，40s钟左右，之后就好了，登陆时有点慢cpu应该会高，其它的数据没有采集好。

大家这两天辛苦了，我总结下软硬件改动如下:

> 1 驱动进行了两个版本的改进。
> 2 硬件上csb进行了10k下拉，以及上电时电路处理。
> 3 应用把喂狗提到encode的前面，避开与sensor的竞争

从这60min的测试来看，出问题的频率还是有改善的，有 no buffer 的情况60s时间就好了，我把喂狗提前一点，当前测试也不会重启。周一再提交测试部做压力测试。

*4. 模组测试？*

有，但是概率低

```bash
fn_monitor2()
{
    echo ____________ `date +%F.%T`
    sleep 8
    # 2.5分钟
    for i in 1 2 3 4 5; do
        top -n3 -d2 -b
        sleep 30
    done

    # 2分钟，如果出问题是否会重启
    sleep 120
    reboot -f
    sleep 1
    reboot -f
}

fn_monitor2&
```

*5.换Flash交叉验证，确定边界*

我们今天(Apr.2)的测试情况:

1 重新测试了模组的cpu高使用率，只有1%，一般情况下都可以修复
2 把模组的程序**移到热点枪上**，cpu 也使用率高，因此推断大概率与硬件相关
3 经过反复查PCB，有个升压 cmos 做了一下修正(更高的电压也许可以让sensor工作更稳定)
4 修改过后的板子运行过程中 cpu高的现象改善很大(**后验证不出帧还是一样**)

今天的测试情况大部分是**程序自动化**做的，明天人工再做一下确认。


*6. CSI_PARAM_0 = 0x1313*

| 关于电压的对比测试 | CSI_PARAM_0 = 0x1313      | 原有cfg         | 
| :--------          | :------------------------ | :-------------- | 
| com1 0.9v          | cpu高，6小时90次，4次无帧 | 17小时，1次无帧 | 
| com3 1.0v          | cpu低，6小时90次，4次无帧 | 17小时，7次无帧 |

经查明，不出帧与sensor 时序相关，经过3.30后的改动之后，还是有机率不出帧问题，加大电压，以及修改sensor的启动参数都不明显，**由于所挂机设备较少，一致性不好**。
基于代码中有不出帧重启机制，且在正常挂机情况下出帧良好，在我司硬件部门协同多次排查PCB板后，Sstar的改进未能有明显效果，
因此，我建议此问题暂停，近期不再做推进。

*7. 公司内部邮件确认*

Apr.9
测试部因为没有发邮件，一直没有重做热噪试验。
与硬件沟通时，变更单已经审批OK。

*8. 与Sstar最终确认*

Apr.10

# 暴露的问题

*1. 一切终将回归，对此问题的复杂度预计没有概念，导致如下问题*

1 手工测试，没有对数据进行严格的量化
2 自动化测试太晚

*2. 底层的逻辑验证太晚*

1 模组测试
2 模组falsh交叉验证

# 流程优化

经过*5.换Flash交叉验证，确定边界*，已经确认是硬件的问题，那么，我们就应该在硬件中进行拆解：

1. 将热点枪上，比模组上多余的器件，全部都拆解掉，比对测试。
2. 再将拆解后的器件，一件一件装上去。


